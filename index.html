<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="ala-cas : ALA customisations of CAS webapp">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>ala-cas</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/AtlasOfLivingAustralia/ala-cas">View on GitHub</a>

          <h1 id="project_title">ala-cas</h1>
          <h2 id="project_tagline">ALA customisations of CAS webapp</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/AtlasOfLivingAustralia/ala-cas/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/AtlasOfLivingAustralia/ala-cas/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h3>

<p>The ALA has deployed the <a href="http://jasig.github.io/cas">Central Authentication Service</a> (version 3.4.2) to provide single sign-on authentication for ALA applications.</p>

<p>A Java web application integrates with CAS by configuring a series of context-params and filters in the application's <a href="https://github.com/AtlasOfLivingAustralia/ala-cas/blob/master/src/main/webapp/WEB-INF/web.xml">web.xml</a>. See <a href="https://wiki.jasig.org/display/CASC/Configuring+the+JA-SIG+CAS+Client+for+Java+in+the+web.xml">CAS Java  Client v3.1</a> for details.</p>

<p>If you are impatient go to the sample web.xml code <a href="#example-web.xml-configuration">bellow</a>.</p>

<h3>
<a id="cas-client-for-java" class="anchor" href="#cas-client-for-java" aria-hidden="true"><span class="octicon octicon-link"></span></a>CAS Client for Java</h3>

<p>Integrating a Java webapp with CAS requires declaring three filters in the order listed (below) in the app's deployment descriptor  (web.xml),  To provide a finer control over which URIs are subject to the CAS client filters we have provided a URIFilter that uses a list of regular expression patterns to determine the URIs to be authenticated.</p>

<ol>
<li><a href="#authentication-filter">Authentication Filter</a></li>
<li><a href="#ticket-validation-filter">Ticket Validation Filter (choice of 2)</a></li>
<li><a href="#httpservletrequestwrapper-filter">HttpServletRequestWrapper Filter</a></li>
</ol>

<p>Diagrams courtesy of <a href="http://www.esup-portail.org/consortium/espace/SSO_1B/cas/eunis2004/cas-eunis2004-article.pdf">Aubry, Mathieu and Marchal</a>.</p>

<h4>
<a id="authentication-filter" class="anchor" href="#authentication-filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authentication Filter</h4>

<p>The Authentication filter determines whether the application user is authenticated or not.  This filter redirects to the CAS server and if the user is not authenticated the CAS login page is rendered.  If the entered credentials (id &amp; password) are valid CAS redirects back to the client application. When the user is authenticated CAS creates a Ticket Granting Cookie (TGC) which is sent to the browser. If the user is already authenticated then the CAS server transparently redirects back to the calling application.<br>
<img src="images/00-CAS-Authentication.png" alt="Alt text"></p>

<p>The TGC is secure (only transmitted to the CAS server via SSL) and opaque (contains no user information).  The TGC's name is CASTGC and expires either when the user's browser is closed or after 3 months if the "Remember Me" option was selected on the Login page.<br>
When the CAS server redirects an authenticated user to the calling service (application) a Service Ticket is delivered as a URI parameter.  The ST is an opaque one-time ticket that is valid only for the calling application for a short period.<br>
<img src="images/01-CAS-Redirection.png" alt="Alt text"></p>

<p>The default behaviour of rendering the CAS login page (if not authenticated) can be disabled by declaring the init-parameter <code>gateway=true</code>. Gateway mode enables the application to make authenticating optional with the provision of a login link. The format of the login URL is <code>https://auth.org.au/cas/login?service=&lt;serviceURL&gt;</code> where serviceURL is the URL of the application web page containing the login link that CAS uses to redirect back to the app.</p>

<h4>
<a id="ticket-validation-filter" class="anchor" href="#ticket-validation-filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Ticket Validation Filter</h4>

<p>The Ticket Validation Filter validates the Service Ticket via an HTTP request to the CAS server and receives properties of the authenticated user in response.<br>
<img src="images/02-CAS-ST-Validation.png" alt="Alt text"></p>

<p>There are 2 validation filters provided by the CAS Java client:</p>

<ul>
<li><code>Cas20ProxyReceivingTicketValidationFilter</code></li>
<li><code>Saml11TicketValidationFilter</code></li>
</ul>

<p>The first uses a simple XML response developed for CAS version 2.0 while the second uses a Security Assertion Markup Language (SAML v1.1) SOAP response.<br>
Both filters work in a simple web app but when trying to configure the Biocache application with the SAML filter there was a conflict with SAX parser dependencies used by the CAS Java client and those of the Biocache app. I recommend using the CAS 2.0 filter for its simplicity.</p>

<h4>
<a id="httpservletrequestwrapper-filter" class="anchor" href="#httpservletrequestwrapper-filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>HttpServletRequestWrapper Filter</h4>

<p>The HttpServletRequestWrapper Filter wraps the normal HttpServletRequest with a wrapper that overrides the following methods to provide data from the CAS Assertion:<br>
<strong>getUserPrincipal()</strong><br>
Returns a <code>org.jasig.cas.client.authentication.AttributePrincipal</code> that implements <code>getAttributes()</code> that returns user attributes as a Map of key/value pairs. Attribute keys currently returned are:  </p>

<ul>
<li>email</li>
<li>authority</li>
<li>firstname</li>
<li>lastname</li>
</ul>

<p><strong>getRemoteUser()</strong><br>
Returns the authenticated user's ID or null if not authenticated.</p>

<p><strong>isUserInRole(String role)</strong><br>
Returns true if the specified role is in the user's authority attribute.</p>

<h4>
<a id="uri-filter" class="anchor" href="#uri-filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>URI Filter</h4>

<p>Optional meta filter that provides filtering based on URI patterns that require authentication (and thus redirection) to the CAS server. There are 3 possible filter configurations and these filtering criteria are applied in the following order:</p>

<table>
<thead>
<tr>
<th align="left">Criterion</th>
<th align="left">context-param</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">URI exclusion</td>
<td align="left">uriExclusionFilterPattern</td>
<td align="left">No</td>
<td align="left">URIs that should not be subject to CAS authentication</td>
</tr>
<tr>
<td align="left">URI inclusion</td>
<td align="left">uriFilterPattern</td>
<td align="left">No</td>
<td align="left">URIs that are to be subject to CAS authentication</td>
</tr>
<tr>
<td align="left">Only if logged in</td>
<td align="left">authenticateOnlyIfLoggedInFilterPattern</td>
<td align="left">No</td>
<td align="left">URIs that should be subject to CAS authentication only if logged in (indicated by the presence of the ALA-Auth cookie)</td>
</tr>
</tbody>
</table>

<p>The list of URI patterns is specified as a comma delimited list of regular expressions in a <code>&lt;context-param&gt;</code>.</p>

<h3>
<a id="example-webxml-configuration" class="anchor" href="#example-webxml-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example web.xml configuration</h3>

<script src="https://gist.github.com/mbohun/34b95b8da748dfa315db.js"></script>

<h3>
<a id="maven-dependencies" class="anchor" href="#maven-dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Maven dependencies</h3>

<script src="https://gist.github.com/mbohun/43abfc0f0fd03ec03ac6.js"></script>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">ala-cas maintained by <a href="https://github.com/AtlasOfLivingAustralia">AtlasOfLivingAustralia</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
